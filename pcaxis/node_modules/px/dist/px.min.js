/*! px - v0.1.2 - 2012-09-13
* http://fod.github.com/px.js/
* Copyright (c) 2012 Fiachra O'Donoghue; Licensed MIT */
(function(){"use strict";var a=this,b=function(){function a(a){this._ctor(a)}function b(a){var b=[];while(a--)b[a]=0;return b}return a.prototype={keyword:function(a){if(!c.include(this.keywords(),a))throw"'"+a+"' is not a valid KEYWORD";return this.metadata[a].TABLE?this.metadata[a].TABLE:this.metadata[a]},title:function(){return this.keyword("TITLE")},keywords:function(){return c.keys(this.metadata)},variables:function(){return c.flatten([this.keyword("STUB"),this.keyword("HEADING")])},variable:function(a){var b=this.variables();return typeof a=="number"?b[a]:typeof a=="string"?c.indexOf(b,a):undefined},values:function(a){var b=typeof a=="number"?this.variable(a):this.variables()[this.variable(a)];return this.keyword("VALUES")[b]},codes:function(a){var b=typeof a=="number"?this.variable(a):this.variables()[this.variable(a)];return!this.metadata.CODES||!this.keyword("CODES")[b]?this.keyword("VALUES")[b]:this.keyword("CODES")[b]},valCounts:function(){var a=[];return c.each(this.variables(),function(b,d){a.push(c.size(this.values(d)))},this),a},value:function(a,b){var d=c.indexOf(this.codes(b),a);return this.values(b)[d]},code:function(a,b){var d=c.indexOf(this.values(b),a);return this.codes(b)[d]},datum:function(a){var b=this.valCounts(),d=0;for(var e=0,f=a.length-1;e<f;e++)d+=a[e]*c.reduce(b.slice(e+1),function(a,b){return a*b});return d+=c.last(a),arguments[1]===!0?d:this.data[d].replace(/"|'/g,"")},dataCol:function(a){var b=this.valCounts(),d=[],e=c.indexOf(a,"*"),f=a.slice(0);for(var g=0;g<b[e];g++)f[e]=g,d.push(this.datum(f,arguments[1]));return d},dataDict:function(a){var b={},d=c.indexOf(a,"*"),e=this.codes(d),f=this.dataCol(a);return c.each(f,function(a,c){b[e[c]]=a}),b},datatable:function(a){var b=this.valCounts(),d=[];c.each(a,function(a,b){a==="*"&&d.push(b)});var e=d[0],f=c.last(d),g=[];for(var h=0;h<b[f];h++)a[e]="*",a[f]=h,g.push(this.dataCol(a,arguments[1]));return g},entries:function(){var a=this.valCounts(),d=this.variables(),e=b(a.length),f=e.length-1,g=[],h=[];for(var i=0,j=a.length;i<j-1;i++)g[i]=c.reduce(a.slice(i+1),function(a,b){return a*b});return c.each(this.data,function(b,c){var i={num:b};for(var j=0,k=d.length;j<k;j++)i[d[j]]=this.values(j)[e[j]];h.push(i);for(var l=0,m=g.length;l<m;l++)(c+1)%g[l]===0&&(e[l]=e[l]===a[l]-1?0:e[l]+1);e[f]=e[f]===a[f]-1?0:e[f]+1},this),h},truncate:function(a){var d=this.valCounts(),e=[];c.each(a,function(b,e){b[0]==="*"&&(a[e]=c.range(0,d[e]-1))});for(var f=0,g=d.length;f<g-1;f++)e[f]=c.reduce(d.slice(f+1),function(a,b){return a*b});e.push(1);for(var h=0,i=a.length;h<i;h++)this.metadata.VALUES[this.variables()[h]]=c.filter(this.metadata.VALUES[this.variables()[h]],function(b,d){return c.indexOf(a[h],d)!==-1});var j=[],k=function m(a,d,e,f){if(a.length>1){f=typeof f!="undefined"?f:1;var g=a.pop(),h=d.pop(),i=e.pop(),k=c.flatten(c.map(c.range(0,g),function(a){return c.include(i,a)?f:b(h)}));m(a,d,e,k)}j.push(c.flatten(f))};k(d,e,a),j=j[0];var l=[];c.each(a[0],function(a){var b=a*e[0],d=b+e[0];l.push(c.filter(c.range(b,d),function(a,b){return j[b]===1}))}),l=c.flatten(l),this.data=c.filter(this.data,function(a,b){return c.indexOf(l,b)!==-1})},subset:function(a){},_ctor:function(a){var b={},c,d=a.split(/\nDATA=/),e=d[0].replace(/;\s*(\r\n?|\n)/g,";;").replace(/;;$/,";").replace(/(\r\n?|\n)/g,"").replace(/""/g," ").split(";;"),f=d[1];for(var g=0,h=e.length;g<h;g++){var i=e[g].match(/^(.+?)(?:\((.+?)\))?=(.+)$/);i[2]||(i[2]="TABLE");var j=i[1],k=i[3].replace(/^"|"$/g,"").split(/","/g),l=i[2].replace(/"/g,"");b[j]||(b[j]={}),j!=="VALUES"?b[j][l]=k.length===1?k[0]:k:b[j][l]=k}c=f.replace(/(\r\n|\r|\n)/g,"").replace(/;\s*/,"").split(/\s+/),b.HEADING||(b.HEADING={TABLE:[]}),this.metadata=b,this.data=c}},a}(),c=a._;typeof exports!="undefined"?(typeof module!="undefined"&&module.exports&&(exports=module.exports=b),exports.Px=b,c=require("underscore")):a.Px=b}).call(this);